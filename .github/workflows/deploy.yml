name: Deploy to EC2

on:
  push:
    branches: [ main, master ]
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [ main, master ]

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    # Ne d√©ployer que si les tests CI ont r√©ussi
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key.pem
        chmod 600 ~/.ssh/deploy_key.pem
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          # Aller dans le r√©pertoire du projet
          cd ~/DevOps-MLOps || { echo "‚ùå R√©pertoire non trouv√©"; exit 1; }
          
          # Rendre le script ex√©cutable s'il existe
          if [ -f deploy.sh ]; then
            chmod +x deploy.sh
            ./deploy.sh
          else
            # Fallback: d√©ploiement manuel si le script n'existe pas
            echo "üì• R√©cup√©ration du code..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
            
            echo "üõë Arr√™t de l'ancien conteneur..."
            docker stop credit-api 2>/dev/null || true
            docker rm credit-api 2>/dev/null || true
            
            echo "üî® Construction de l'image Docker..."
            docker build -f docker/Dockerfile -t credit-scoring-api .
            
            echo "üöÄ Lancement du nouveau conteneur..."
            docker run -d -p 5000:5000 --name credit-api --restart unless-stopped credit-scoring-api
            
            sleep 5
            if curl -f http://localhost:5000/health > /dev/null 2>&1; then
              echo "‚úÖ API d√©marr√©e avec succ√®s!"
            else
              echo "‚ùå Erreur: L'API ne r√©pond pas"
              docker logs credit-api
              exit 1
            fi
          fi
        ENDSSH
    
    - name: Verify deployment
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
      run: |
        echo "üîç V√©rification depuis l'ext√©rieur..."
        sleep 3
        if curl -f http://${{ secrets.EC2_HOST }}:5000/health; then
          echo "‚úÖ L'API est accessible depuis l'ext√©rieur!"
        else
          echo "‚ö†Ô∏è L'API n'est pas accessible depuis l'ext√©rieur (v√©rifiez le Security Group)"
        fi

